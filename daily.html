<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Form Rutinan Faris</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://unpkg.com/lucide@latest"></script>
<style>
/* Loader umum */
#loader {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(255, 255, 255, 0.9);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 50;
  transition: opacity 0.4s ease, visibility 0.4s ease;
}
#loader.fade-out {
  opacity: 0;
  visibility: hidden;
}
.spinner {
  width: 50px;
  height: 50px;
  border: 5px solid #d1d5db;
  border-top-color: #2563eb;
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
.animate-fadeIn { animation: fadeIn 0.5s ease-in; }
</style>
</head>

<body class="bg-blue-50 min-h-screen flex items-center justify-center">

<!-- LOADER -->
<div id="loader">
  <div class="flex flex-col items-center space-y-2">
    <div class="spinner"></div>
    <p class="text-blue-700 font-semibold">Memuat...</p>
  </div>
</div>

<!-- LOGIN PAGE -->
<div id="loginPage" class="w-full max-w-sm bg-white p-6 rounded-2xl shadow-md">
  <h2 class="text-2xl font-bold text-center text-blue-700 mb-4">Login Disini</h2>
  <input id="loginName" type="text" placeholder="Masukkan Nama Lengkap" class="w-full p-2 border rounded mb-3 focus:outline-blue-500">
  <button onclick="handleLogin()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded">Masuk</button>
</div>

<!-- MAIN FORM PAGE -->
<div id="mainPage" class="hidden w-full max-w-md bg-white p-6 rounded-2xl shadow-lg relative">
  <h2 class="text-2xl font-bold text-center text-blue-700 mb-4">Daily Routine Faris</h2>

  <!-- GREETING -->
  <div class="mb-4 text-left">
    <p id="greeting" class="text-lg font-semibold text-gray-700"></p>
    <p class="text-sm text-gray-500">Harap isi sesuai dengan yang kamu lakukan hari ini.</p>
  </div>

  <div class="mb-3 flex items-center justify-between">
    <div class="flex-1 mr-2">
      <label class="block text-sm font-semibold">Nama Lengkap:</label>
      <input id="userName" readonly class="w-full p-2 border rounded bg-gray-100">
    </div>
    <button id="logoutBtn" onclick="logout()" class="mt-5 p-2 rounded hover:bg-gray-200 text-gray-500" title="Logout">
      <i data-lucide="log-out" class="w-5 h-5"></i>
    </button>
  </div>

  <div class="mb-3">
    <label class="block text-sm font-semibold mb-1">Sholat Wajib Yang Kamu Lakukan:</label>
    <div id="sholatButtons" class="grid grid-cols-3 gap-2">
      <button class="btn-sholat" data-value="Subuh">Subuh</button>
      <button class="btn-sholat" data-value="Dzuhur">Dzuhur</button>
      <button class="btn-sholat" data-value="Ashar">Ashar</button>
      <button class="btn-sholat" data-value="Maghrib">Maghrib</button>
      <button class="btn-sholat" data-value="Isya">Isya</button>
    </div>
  </div>

  <div class="mb-3">
    <label class="block text-sm font-semibold">Hafalan / Murojaah Yang kamu Lakukan:</label>
    <input type="checkbox" id="hafalanCheck" class="mr-2"> Sudah Melakukan
    <div id="hafalanInput" class="hidden mt-2">
      <label class="text-sm">Jumlah Juz:</label>
      <input id="juzInput" type="number" min="0" class="w-full p-2 border rounded">
    </div>
  </div>

  <div class="grid grid-cols-3 gap-2 mb-3">
    <div>
      <label class="block text-sm font-semibold">Tahajud</label>
      <input id="tahajud" type="number" class="w-full p-2 border rounded" placeholder="rakaat">
    </div>
    <div>
      <label class="block text-sm font-semibold">Dhuha</label>
      <input id="dhuha" type="number" class="w-full p-2 border rounded" placeholder="rakaat">
    </div>
    <div>
      <label class="block text-sm font-semibold">Rawatib</label>
      <input id="rawatib" type="number" class="w-full p-2 border rounded" placeholder="rakaat">
    </div>
  </div>

  <div class="flex gap-2">
    <button onclick="handleSave()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 rounded">Simpan</button>
    <button onclick="clearData()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-black py-2 rounded">Kosongkan</button>
  </div>
</div>

<!-- POPUP -->
<div id="popup" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
  <div class="bg-white p-6 rounded-2xl shadow-xl text-center">
    <h3 class="text-xl font-semibold text-blue-700 mb-2">Terima kasih!</h3>
    <p>Data Daily Routine kamu sudah tersimpan üôè</p>
    <button onclick="closePopup()" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">Tutup</button>
  </div>
</div>

<script>
const { jsPDF } = window.jspdf;
lucide.createIcons();

window.addEventListener("load", () => {
  setTimeout(() => document.getElementById("loader").classList.add("fade-out"), 400);
});

// Tombol sholat toggle
document.querySelectorAll('.btn-sholat').forEach(btn => {
  btn.classList.add('bg-gray-100', 'p-2', 'rounded', 'text-sm');
  btn.addEventListener('click', () => btn.classList.toggle('bg-blue-200'));
});

// Hafalan fade-in
document.getElementById('hafalanCheck').addEventListener('change', e => {
  const input = document.getElementById('hafalanInput');
  if (e.target.checked) {
    input.classList.remove('hidden');
    input.classList.add('animate-fadeIn');
  } else {
    input.classList.add('hidden');
  }
});

// LOGIN dengan loading
function handleLogin() {
  const name = document.getElementById('loginName').value.trim();
  if (!name) return alert('Masukkan nama terlebih dahulu');

  const loader = document.getElementById("loader");
  loader.classList.remove("fade-out");

  setTimeout(() => {
    localStorage.setItem('rohisUser', name);
    document.getElementById('userName').value = name;
    document.getElementById('loginPage').classList.add('hidden');
    document.getElementById('mainPage').classList.remove('hidden');
    document.getElementById('greeting').textContent = `Assalamu'alaikum, ${name}!`;
    loadData();
    loader.classList.add("fade-out");
  }, 800);
}

// LOGOUT
function logout() {
  localStorage.removeItem('rohisUser');
  document.getElementById('mainPage').classList.add('hidden');
  document.getElementById('loginPage').classList.remove('hidden');
}

// POPUP
function showPopup() {
  document.getElementById('popup').classList.remove('hidden');
}
function closePopup() {
  document.getElementById('popup').classList.add('hidden');
}

// HANDLE SIMPAN DENGAN LOADING
function handleSave() {
  const loader = document.getElementById("loader");
  loader.classList.remove("fade-out");
  setTimeout(() => {
    saveData();
    loader.classList.add("fade-out");
  }, 1000);
}

// SIMPAN DATA
function saveData() {
  const name = localStorage.getItem('rohisUser') || 'Tanpa Nama';
  const date = new Date().toLocaleDateString('id-ID');
  const selectedSholat = Array.from(document.querySelectorAll('.btn-sholat.bg-blue-200')).map(b => b.dataset.value);
  const hafalan = document.getElementById('hafalanCheck').checked ? (document.getElementById('juzInput').value || 0) : 0;
  const tahajud = document.getElementById('tahajud').value || 0;
  const dhuha = document.getElementById('dhuha').value || 0;
  const rawatib = document.getElementById('rawatib').value || 0;

  let data = JSON.parse(localStorage.getItem('rohisData') || '[]');
  const weekAgo = Date.now() - 7 * 24 * 60 * 60 * 1000;
  data = data.filter(d => new Date(d.timestamp).getTime() > weekAgo);

  data.push({
    name, date, sholat: selectedSholat.join(', '), hafalan, tahajud, dhuha, rawatib,
    timestamp: new Date().toISOString()
  });
  localStorage.setItem('rohisData', JSON.stringify(data));

  generatePDF(data, name);
  showPopup();
}

// GENERATE PDF
function generatePDF(data, name) {
  const doc = new jsPDF();
  doc.setFontSize(14);
  doc.text(`Nama: ${name}`, 10, 15);

  const startY = 25;
  const headers = ["Tanggal", "Sholat 5 Waktu", "Hafalan (Juz)", "Tahajud", "Dhuha", "Rawatib"];
  const colWidths = [25, 60, 25, 20, 20, 25];
  let y = startY;

  let x = 10;
  doc.setFontSize(10);
  headers.forEach((h, i) => { doc.text(h, x, y); x += colWidths[i]; });
  y += 6;
  doc.line(10, y - 4, 190, y - 4);

  data.forEach(row => {
    x = 10;
    const vals = [row.date, row.sholat, String(row.hafalan), String(row.tahajud), String(row.dhuha), String(row.rawatib)];
    vals.forEach((v, i) => {
      doc.text(v, x, y);
      x += colWidths[i];
    });
    y += 6;
  });

  doc.save(`DailyRoutine_${name}_${new Date().toLocaleDateString('id-ID')}.pdf`);
}

// KOSONGKAN FORM
function clearData() {
  document.querySelectorAll('.btn-sholat').forEach(b => b.classList.remove('bg-blue-200'));
  document.getElementById('hafalanCheck').checked = false;
  document.getElementById('hafalanInput').classList.add('hidden');
  document.getElementById('juzInput').value = '';
  document.getElementById('tahajud').value = '';
  document.getElementById('dhuha').value = '';
  document.getElementById('rawatib').value = '';
}

// LOAD DATA SAAT LOGIN
function loadData() {
  const data = JSON.parse(localStorage.getItem('rohisData') || '[]');
  const name = localStorage.getItem('rohisUser');
  if (name) {
    document.getElementById('userName').value = name;
    document.getElementById('greeting').textContent = `Assalamu'alaikum, ${name}!`;
  }
}
</script>
</body>
</html>

<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Undian Festival Hadrah 2026 (Online)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* styling ekstra untuk PDF preview/print */
    .ticket-preview {
      width: 210mm; /* A4 width */
      height: 297mm; /* A4 height */
      box-sizing: border-box;
      padding: 24mm;
    }
    table.data-table th, table.data-table td {
      border: 1px solid #e2e8f0;
    }
    /* small responsive tweak */
    @media (max-width: 640px) {
      .max-w-3xl { max-width: 95% !important; }
      main { padding: 12px; }
    }
  </style>
</head>
<body class="bg-blue-50 text-gray-800 font-sans relative">

  <header class="flex justify-between items-center p-4 bg-white shadow">
    <h1 class="text-lg font-bold text-blue-700 cursor-pointer">Undian Festival Hadrah 2026 (Online)</h1>
    <button id="logoutBtn" class="text-blue-600 hover:text-red-500 text-sm font-semibold hidden">üö™ Keluar</button>
  </header>

  <main class="flex flex-col items-center justify-start min-h-screen p-6">
    <section id="loginSection" class="bg-white shadow-lg rounded-2xl p-6 w-full max-w-md text-center space-y-4">
      <h2 class="text-2xl font-bold text-blue-700">Assalamu‚Äôalaikum, Selamat Datang!</h2>
      <p class="text-gray-600">Masukkan nama ketua dan pilih sekolah untuk mendapatkan nomor undian. Setiap sekolah hanya mendapat 1 nomor.</p>

      <input id="namaKetua" type="text" placeholder="Nama Ketua" class="w-full border rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-blue-400" />
      <select id="sekolah" class="w-full border rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-blue-400">
        <option value="">Pilih Sekolah</option>
        <option>SMKN 1 Sragen</option>
        <option>SMKN 2 Sragen</option>
        <option>SMKN 3 Sragen</option>
        <option>SMAN 1 Sragen</option>
        <option>SMAN 2 Sragen</option>
        <option>SMAN 3 Sragen</option>
        <option>MAN 1 Sragen</option>
        <option>MAN 2 Sragen</option>
        <option>SMA Muhammadiyah Sragen</option>
        <option>SMK Muhammadiyah 1 Sragen</option>
        <option>SMK Muhammadiyah 2 Sragen</option>
        <option>MA Al-Islam Sragen</option>
        <option>MA Walisongo Sragen</option>
        <option>SMA Islam Sragen</option>
        <option>SMK Batik Sragen</option>
        <option>SMK Bhakti Sragen</option>
        <option>SMK Ngrampal</option>
        <option>SMA Kedawung</option>
        <option>SMA Miri</option>
        <option>SMA Plupuh</option>
      </select>

      <div class="flex gap-2">
        <button id="btnUndian" class="flex-1 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition">üéüÔ∏è Dapatkan Nomor Undian</button>
        <button id="btnAcakSemua" class="bg-yellow-500 text-white py-2 px-3 rounded-lg hover:bg-yellow-600 transition" title="Assign random number to every remaining school">üîÄ Acak Semua</button>
      </div>

      <p id="hasil" class="text-blue-700 font-semibold mt-2 min-h-[28px]"></p>
      <p id="sisaInfo" class="text-sm text-gray-600"></p>
    </section>

    <section id="adminLogin" class="hidden bg-white shadow-lg rounded-2xl p-6 w-full max-w-md text-center space-y-4 mt-6">
      <h2 class="text-xl font-bold text-blue-700">Login Admin</h2>
      <input id="adminPass" type="password" placeholder="Password Admin" class="w-full border rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-blue-400" />
      <button id="btnAdminLogin" class="bg-blue-600 text-white w-full py-2 rounded-lg hover:bg-blue-700 transition">Masuk Admin</button>
    </section>

    <section id="adminPanel" class="hidden bg-white shadow-lg rounded-2xl p-6 w-full max-w-3xl text-center space-y-4 mt-6">
      <h2 class="text-xl font-bold text-blue-700">Panel Admin</h2>
      <div class="flex flex-wrap gap-2 justify-center">
        <button id="resetBtn" class="bg-red-500 text-white py-2 px-4 rounded-lg hover:bg-red-600">Reset Lokal (refresh UI)</button>
        <button id="exportPDF" class="bg-green-500 text-white py-2 px-4 rounded-lg hover:bg-green-600">Unduh Tabel PDF (A4)</button>
        <button id="downloadCSV" class="bg-indigo-500 text-white py-2 px-4 rounded-lg hover:bg-indigo-600">Unduh CSV</button>
      </div>

      <div class="overflow-x-auto">
        <table id="tabelData" class="w-full mt-4 table-auto data-table">
          <thead class="bg-blue-100">
            <tr>
              <th class="border p-2 text-left">#</th>
              <th class="border p-2 text-left">Nama Ketua</th>
              <th class="border p-2 text-left">Sekolah</th>
              <th class="border p-2 text-left">Nomor Undian</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- libs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
    // ======= TERHUBUNG DENGAN WEB APP GOOGLE APPS SCRIPT ANDA =======
    const API_URL = "https://script.google.com/macros/s/AKfycbzL2VFHxZw8zuX5qw5SMpIU5US4oc-kxalTZJbFZtRrnlNN6bksYvOL8lvFQS_4kOr_Sw/exec";
    // ============================================================

    window.onload = () => {
      const hasil = document.getElementById("hasil");
      const tabelBody = document.querySelector("#tabelData tbody");
      const sekolahSelect = document.getElementById("sekolah");
      const sisaInfo = document.getElementById("sisaInfo");

      // state UI
      let dataUndian = []; // diisi dari server GET ?action=all
      let remainingSekolah = [];

      // helper
      function escapeHtml(text) {
        if (!text) return "";
        return String(text).replace(/[&<>"']/g, (m) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
      }

      // ambil data awal dari server (jika tersedia)
      async function fetchAllData() {
        try {
          const res = await fetch(API_URL + "?action=all");
          if (!res.ok) throw new Error("Tidak bisa ambil data server");
          const json = await res.json();
          if (!json.success) throw new Error(json.message || "Gagal ambil data");
          dataUndian = json.data || [];
        } catch (e) {
          // fallback: kosong
          dataUndian = [];
          console.warn("Gagal fetch data awal:", e.message);
        }
        updateSelectOptions();
        refreshTabel();
        updateSisaInfo();
      }

      function updateSelectOptions() {
        const used = dataUndian.map(d => d.sekolah);
        Array.from(sekolahSelect.options).forEach(opt => {
          if (!opt.value) return;
          opt.disabled = used.includes(opt.value);
          opt.text = used.includes(opt.value) ? `${opt.value} ‚Äî (sudah mendapat nomor)` : opt.value;
        });
        const semuaSekolah = Array.from(sekolahSelect.options).map(o => o.value).filter(v=>v);
        remainingSekolah = semuaSekolah.filter(s => !used.includes(s));
      }

      function refreshTabel() {
        const sorted = [...dataUndian].sort((a,b) => a.nomor - b.nomor);
        tabelBody.innerHTML = sorted.map((d,i) =>
          `<tr>
            <td class='border p-2'>${i+1}</td>
            <td class='border p-2'>${escapeHtml(d.nama)}</td>
            <td class='border p-2'>${escapeHtml(d.sekolah)}</td>
            <td class='border p-2 font-bold text-blue-700'>${d.nomor}</td>
          </tr>`
        ).join("") || `<tr><td class="p-4" colspan="4">Belum ada peserta terdaftar.</td></tr>`;
      }

      function updateSisaInfo() {
        const sisa = remainingSekolah ? remainingSekolah.length : "?";
        sisaInfo.textContent = `Sisa sekolah yang belum diundi: ${sisa}.`;
      }

      // POST ke server untuk minta nomor unik
      document.getElementById("btnUndian").onclick = async () => {
        const nama = document.getElementById("namaKetua").value.trim();
        const sekolah = sekolahSelect.value;

        if (!nama || !sekolah) {
          alert("Lengkapi nama dan pilih sekolah!");
          return;
        }

        hasil.innerHTML = "Memproses ...";
        try {
          const res = await fetch(API_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ nama, sekolah })
          });
          const data = await res.json();
          if (!data.success) {
            hasil.innerHTML = `<span class="text-red-600 font-semibold">${data.message}</span>`;
            if (data.nomor) hasil.innerHTML += `<div class="mt-2">Nomor terdaftar: <strong>${data.nomor}</strong></div>`;
            await fetchAllData();
            return;
          }

          hasil.innerHTML = `‚úÖ Nomor Undian Anda: <span class="font-bold text-2xl text-blue-700">${data.nomor}</span>`;

          dataUndian.push({ nama: data.nama, sekolah: data.sekolah, nomor: data.nomor });
          updateSelectOptions();
          refreshTabel();
          updateSisaInfo();

          await generatePDFTicket({ nama: data.nama, sekolah: data.sekolah, nomor: data.nomor });

        } catch (err) {
          console.error(err);
          hasil.innerHTML = `<span class="text-red-600">Gagal terhubung ke server: ${err.message}</span>`;
        }
      };

      // Acak semua: panggil POST untuk setiap sekolah tersisa
      document.getElementById("btnAcakSemua").onclick = async () => {
        if (!confirm("Yakin ingin mengacak dan memberi nomor untuk semua sekolah yang tersisa sekaligus?")) return;
        await fetchAllData();
        if (!remainingSekolah || remainingSekolah.length === 0) {
          alert("Tidak ada sekolah tersisa.");
          return;
        }

        for (const s of [...remainingSekolah]) {
          try {
            const res = await fetch(API_URL, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ nama: "(otomatis)", sekolah: s })
            });
            const data = await res.json();
            if (data.success) {
              dataUndian.push({ nama: data.nama, sekolah: data.sekolah, nomor: data.nomor });
            } else {
              console.warn("Gagal assign:", data);
            }
          } catch (e) {
            console.error("Error assign otomatis:", e);
          }
        }
        await fetchAllData();
        alert("Proses acak semua selesai (cek tabel).");
      };

      // Admin login lokal
      document.getElementById("btnAdminLogin").onclick = () => {
        const pass = document.getElementById("adminPass").value;
        if (pass === "admin123") {
          document.getElementById("adminPanel").classList.remove("hidden");
          document.getElementById("adminLogin").classList.add("hidden");
          document.getElementById("logoutBtn").classList.remove("hidden");
          refreshTabel();
        } else {
          alert("Password salah!");
        }
      };

      // Reset lokal UI (tidak menghapus sheet) ‚Äî berguna jika ada masalah UI
      document.getElementById("resetBtn").onclick = async () => {
        if (!confirm("Reset tampilan lokal (tidak menghapus data di Google Sheet)?")) return;
        dataUndian = [];
        await fetchAllData();
        alert("Tampilan lokal disegarkan.");
      };

      // Export to A4 PDF
      document.getElementById("exportPDF").onclick = async () => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ unit: 'mm', format: 'a4', orientation: 'portrait' });
        const marginLeft = 14;
        let y = 18;
        doc.setFontSize(16);
        doc.setTextColor(15, 76, 129);
        doc.text("Data Undian ‚Äî Festival Hadrah 2026", marginLeft, y);
        y += 8;
        doc.setFontSize(10);
        doc.setTextColor(80, 80, 80);
        doc.text(`Dicetak: ${new Date().toLocaleString()}`, marginLeft, y);
        y += 8;

        const rows = [...dataUndian].sort((a,b)=>a.nomor-b.nomor).map((d,i)=>[
          String(i+1),
          d.nama,
          d.sekolah,
          String(d.nomor)
        ]);

        doc.setFontSize(11);
        doc.setTextColor(0,0,0);
        doc.setFillColor(235, 245, 255);
        doc.rect(marginLeft - 2, y - 4, 182, 10, 'F');
        doc.text("No", marginLeft, y + 3);
        doc.text("Nama Ketua", marginLeft + 12, y + 3);
        doc.text("Sekolah", marginLeft + 70, y + 3);
        doc.text("Nomor", marginLeft + 160, y + 3);
        y += 10;

        const pageHeight = 297;
        const lineHeight = 7;
        const maxRowsPerPage = Math.floor((pageHeight - y - 20) / lineHeight);

        let rowCount = 0;
        for (let i = 0; i < rows.length; i++) {
          if (rowCount >= maxRowsPerPage) {
            doc.addPage();
            y = 18;
            rowCount = 0;
          }
          const r = rows[i];
          doc.text(r[0], marginLeft, y + 4 + (rowCount * lineHeight));
          doc.text(truncateText(doc, r[1], 50), marginLeft + 12, y + 4 + (rowCount * lineHeight));
          doc.text(truncateText(doc, r[2], 70), marginLeft + 70, y + 4 + (rowCount * lineHeight));
          doc.text(r[3], marginLeft + 160, y + 4 + (rowCount * lineHeight));
          rowCount++;
        }

        doc.save("Data_Undian_A4.pdf");
      };

      function truncateText(doc, text, maxChars) {
        if (!text) return "";
        text = String(text);
        return text.length > maxChars ? text.slice(0, maxChars - 3) + "..." : text;
      }

      // CSV download
      document.getElementById("downloadCSV").onclick = () => {
        if (dataUndian.length === 0) {
          alert("Belum ada data untuk diunduh.");
          return;
        }
        const header = ["Nama Ketua","Sekolah","Nomor"];
        const rows = dataUndian.map(d => [escapeCsv(d.nama), escapeCsv(d.sekolah), d.nomor]);
        const csvContent = [header.join(","), ...rows.map(r=>r.join(","))].join("\n");
        const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "data_undian.csv";
        a.click();
        URL.revokeObjectURL(url);
      };

      function escapeCsv(text) {
        if (text == null) return "";
        if (String(text).includes(",") || String(text).includes('"') || String(text).includes("\n")) {
          return '"' + String(text).replace(/"/g, '""') + '"';
        }
        return String(text);
      }

      // Logout admin
      document.getElementById("logoutBtn").onclick = () => {
        document.getElementById("adminPanel").classList.add("hidden");
        document.getElementById("adminLogin").classList.add("hidden");
        document.getElementById("logoutBtn").classList.add("hidden");
      };

      // header click 3x to open admin
      let headerClickCount = 0;
      const headerEl = document.querySelector("header h1");
      headerEl.addEventListener("click", () => {
        headerClickCount++;
        if (headerClickCount === 3) {
          headerClickCount = 0;
          document.getElementById("adminLogin").classList.remove("hidden");
          alert("üîí Mode Admin dibuka");
          window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" });
        }
        setTimeout(() => headerClickCount = 0, 1500);
      });

      // initial load
      fetchAllData();

      // ---------------- PDF ticket generation (A4 full) ----------------
      async function generatePDFTicket({ nama, sekolah, nomor }) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ unit: 'mm', format: 'a4', orientation: 'portrait' });

        doc.setFillColor(245, 249, 255);
        doc.rect(0, 0, 210, 297, 'F');

        doc.setDrawColor(20, 66, 130);
        doc.setLineWidth(0.8);
        doc.rect(14, 14, 182, 40);
        doc.setFontSize(16);
        doc.setTextColor(15, 76, 129);
        doc.text("Festival Hadrah 2026", 105, 28, { align: "center" });
        doc.setFontSize(10);
        doc.setTextColor(80,80,80);
        doc.text("Selayang Pandang Undian", 105, 36, { align: "center" });

        doc.setDrawColor(150,150,150);
        doc.setLineWidth(0.4);
        doc.rect(14, 60, 182, 170);

        const centerX = 105;
        let cursorY = 85;
        doc.setFontSize(12);
        doc.setTextColor(20,20,20);
        doc.text(`Assalamu'alaikum, ${nama}`, 20, cursorY);
        cursorY += 8;
        doc.setFontSize(11);
        doc.text(`Sekolah: ${sekolah}`, 20, cursorY);
        cursorY += 10;

        doc.setFontSize(72);
        doc.setTextColor(0, 51, 153);
        doc.text(String(nomor), centerX, cursorY + 35, { align: "center" });

        doc.setFontSize(11);
        doc.setTextColor(90,90,90);
        doc.text("Mohon simpan tiket ini dan tunjukkan saat pengundian.", 20, 250);
        doc.text(`Dicetak: ${new Date().toLocaleString()}`, 20, 260);

        doc.setDrawColor(15,76,129);
        doc.setLineWidth(0.6);
        doc.line(14, 276, 196, 276);

        const safeName = String(nama).replace(/\s+/g, "_").replace(/[^\w\-]/g, "");
        doc.save(`Undian_${safeName}_${nomor}.pdf`);
      }

    }; // end onload
  </script>

</body>
  </html>

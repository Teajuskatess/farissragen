<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Undian Hadrah 2026</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body class="bg-blue-50 text-gray-800">
<main class="max-w-md mx-auto bg-white shadow-lg rounded-2xl p-6 mt-10 text-center">
  <h1 class="text-2xl font-bold text-blue-700 mb-3">Undian Festival Hadrah 2026</h1>
  <p class="text-gray-600 mb-5">Masukkan nama ketua dan pilih sekolah untuk mendapatkan nomor undian unik.</p>

  <input id="namaKetua" type="text" placeholder="Nama Ketua"
    class="border w-full p-2 mb-3 rounded-lg focus:ring focus:ring-blue-400"/>

  <select id="sekolah"
    class="border w-full p-2 mb-3 rounded-lg focus:ring focus:ring-blue-400">
    <option value="">Pilih Sekolah</option>
    <option>SMKN 1 Sragen</option>
    <option>SMKN 2 Sragen</option>
    <option>SMKN 3 Sragen</option>
    <option>SMAN 1 Sragen</option>
    <option>SMAN 2 Sragen</option>
    <option>SMAN 3 Sragen</option>
    <option>MAN 1 Sragen</option>
    <option>MAN 2 Sragen</option>
    <option>SMA Muhammadiyah Sragen</option>
    <option>SMK Muhammadiyah 1 Sragen</option>
    <option>SMK Muhammadiyah 2 Sragen</option>
    <option>MA Al-Islam Sragen</option>
    <option>MA Walisongo Sragen</option>
    <option>SMA Islam Sragen</option>
    <option>SMK Batik Sragen</option>
    <option>SMK Bhakti Sragen</option>
    <option>SMK Ngrampal</option>
    <option>SMA Kedawung</option>
    <option>SMA Miri</option>
    <option>SMA Plupuh</option>
  </select>

  <button id="btnUndian"
    class="bg-blue-600 text-white w-full py-2 rounded-lg hover:bg-blue-700 transition">üéüÔ∏è Ambil Nomor Undian</button>

  <p id="hasil" class="text-blue-700 font-semibold mt-4 min-h-[28px]"></p>
</main>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbw-LRZwTQnifXRlN8D8_65p-ADpgxg7XnaQqu8Alf8b-kRGdVUgCMAd_On1rRXKzied1Q/exec";

document.getElementById("btnUndian").onclick = async () => {
  const nama = document.getElementById("namaKetua").value.trim();
  const sekolah = document.getElementById("sekolah").value;
  const hasil = document.getElementById("hasil");

  if (!nama || !sekolah) {
    alert("Isi nama dan pilih sekolah!");
    return;
  }

  hasil.textContent = "‚è≥ Sedang memproses...";

  try {
    // FIXED FETCH (tidak lagi Failed to fetch)
    const res = await fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "text/plain;charset=UTF-8" },
      body: JSON.stringify({ nama, sekolah }),
    });

    const data = await res.json();

    if (!data.success) {
      hasil.innerHTML = `<span class='text-red-600'>${data.message}</span>`;
      if (data.nomor) hasil.innerHTML += `<br>Nomor: <b>${data.nomor}</b>`;
      return;
    }

    hasil.innerHTML = `‚úÖ Nomor Undian Anda: <span class='text-2xl font-bold'>${data.nomor}</span>`;
    generatePDF(data);
  } catch (err) {
    hasil.innerHTML = `<span class='text-red-600'>Gagal terhubung ke server: ${err.message}</span>`;
  }
};

async function generatePDF({ nama, sekolah, nomor }) {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit: 'mm', format: 'a4' });

  doc.setFontSize(18);
  doc.setTextColor(0, 51, 153);
  doc.text("TIKET UNDIAN FESTIVAL HADRAH 2026", 105, 40, { align: "center" });

  doc.setFontSize(12);
  doc.setTextColor(0, 0, 0);
  doc.text(`Nama Ketua: ${nama}`, 20, 70);
  doc.text(`Sekolah: ${sekolah}`, 20, 80);

  doc.setFontSize(60);
  doc.setTextColor(255, 0, 0);
  doc.text(String(nomor), 105, 150, { align: "center" });

  doc.setFontSize(11);
  doc.setTextColor(80, 80, 80);
  doc.text("Harap simpan tiket ini dan tunjukkan saat acara undian berlangsung.", 20, 270);
  doc.text(`Dicetak: ${new Date().toLocaleString()}`, 20, 280);

  const safeName = nama.replace(/\s+/g, "_").replace(/[^\w\-]/g, "");
  doc.save(`Undian_${safeName}_${nomor}.pdf`);
}
</script>
</body>
</html>
